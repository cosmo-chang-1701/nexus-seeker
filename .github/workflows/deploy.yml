name: Build and Deploy to DigitalOcean

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}
  SERVICE_NAME: nexus-seeker-bot

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            # 使用 short SHA 作為主要部署標籤，這樣每次 push 都會有唯一 ID
            type=sha,format=short,prefix=sha-,priority=1000
            type=edge,branch=main

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to DigitalOcean
    needs: build-and-push
    environment: production
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Droplet via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
          IMAGE_BASE: ghcr.io/${{ github.repository }}
          DEPLOY_TAG: ${{ needs.build-and-push.outputs.version }}
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_ADMIN_USER_ID: ${{ secrets.DISCORD_ADMIN_USER_ID }}
          LLM_API_BASE: ${{ secrets.LLM_API_BASE }}
          LLM_MODEL_NAME: ${{ secrets.LLM_MODEL_NAME }}
          API_KEY: ${{ secrets.API_KEY }}
          TZ: "America/New_York"
        with:
          host: ${{ secrets.DIGITALOCEAN_HOST }}
          username: ${{ secrets.DIGITALOCEAN_USERNAME }}
          key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
          envs: SERVICE_NAME,IMAGE_BASE,DEPLOY_TAG,DISCORD_TOKEN,DISCORD_ADMIN_USER_ID,LLM_API_BASE,LLM_MODEL_NAME,API_KEY,TZ
          script: |
            # 轉換為小寫
            LOWER_IMAGE_NAME=$(echo "$IMAGE_BASE" | tr '[:upper:]' '[:lower:]')
            FULL_IMAGE_URL="$LOWER_IMAGE_NAME:$DEPLOY_TAG"

            if ! docker info | grep -q "Swarm: active"; then
              docker swarm init
            fi

            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

            # 拉取特定 SHA 版本的映像檔
            docker pull $FULL_IMAGE_URL

            docker volume create nexus-data || true

            echo "--- Deploying stack $SERVICE_NAME with image $FULL_IMAGE_URL ---"
            
            # 修正 5: 加上 --with-registry-auth 並確保 image 標籤是唯一的 SHA
            docker stack deploy --with-registry-auth -c - $SERVICE_NAME <<EOF
            version: '3.8'
            services:
              bot:
                image: $FULL_IMAGE_URL
                deploy:
                  replicas: 1
                  restart_policy:
                    condition: any
                  update_config:
                    order: start-first
                    failure_action: rollback
                    delay: 5s
                volumes:
                  - nexus-data:/app/data
                environment:
                  - TZ=\$TZ
                  - DISCORD_TOKEN=\$DISCORD_TOKEN
                  - DISCORD_ADMIN_USER_ID=\$DISCORD_ADMIN_USER_ID
                  - LLM_API_BASE=\$LLM_API_BASE
                  - LLM_MODEL_NAME=\$LLM_MODEL_NAME
                  - API_KEY=\$API_KEY
            volumes:
              nexus-data:
                external: true
            EOF

            docker image prune -af