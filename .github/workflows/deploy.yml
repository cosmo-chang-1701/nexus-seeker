name: Build and Deploy Nexus Core to DigitalOcean

on:
  push:
    branches:
      - main
    paths:
      - 'nexus_core/**'
      - '.github/workflows/**'

# 避免同時執行多個部署，若有新 Push 則取消舊的部署任務
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RAW_IMAGE_NAME: ghcr.io/${{ github.repository }}
  SERVICE_NAME: nexus-seeker-service

jobs:
  # --- 第一個任務：建置並推送 Docker 映像 ---
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.vars.outputs.sha_short }}
      image_lower: ${{ steps.vars.outputs.image_lower }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set outputs
        id: vars
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "image_lower=$(echo ${{ env.RAW_IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.vars.outputs.image_lower }}
          tags: |
            type=sha,format=short,prefix=,suffix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./nexus_core
          file: ./nexus_core/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # --- 第二個任務：部署到 DigitalOcean VM ---
  deploy:
    name: Deploy to DigitalOcean
    needs: build-and-push
    environment: production
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Droplet via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.version }}
          IMAGE_LOWER: ${{ needs.build-and-push.outputs.image_lower }}
          # 注入環境變數
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_ADMIN_USER_ID: ${{ secrets.DISCORD_ADMIN_USER_ID }}
          LLM_API_BASE: ${{ secrets.LLM_API_BASE }}
          LLM_MODEL_NAME: ${{ secrets.LLM_MODEL_NAME }}
          API_KEY: ${{ secrets.API_KEY }}
          TUNNEL_URL: ${{ secrets.TUNNEL_URL }}
          TZ: "America/New_York"
        with:
          host: ${{ secrets.DIGITALOCEAN_HOST }}
          username: ${{ secrets.DIGITALOCEAN_USERNAME }}
          key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
          envs: SERVICE_NAME,IMAGE_TAG,IMAGE_LOWER,DISCORD_TOKEN,DISCORD_ADMIN_USER_ID,LLM_API_BASE,LLM_MODEL_NAME,API_KEY,TUNNEL_URL,TZ
          script: |
            FULL_IMAGE_URL="$IMAGE_LOWER:$IMAGE_TAG"
            echo "Deploying version: $FULL_IMAGE_URL"

            # 1. 初始化 Swarm (如果尚未啟動)
            if ! docker info | grep -q "Swarm: active"; then
              docker swarm init
            fi

            # 2. 登入 Registry
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

            # 3. 預先拉取新映像檔
            docker pull $FULL_IMAGE_URL

            # 4. 確保 Volume 存在
            docker volume create nexus-data || true

            # 5. 使用 Docker Stack 部署
            docker stack deploy --with-registry-auth -c - $SERVICE_NAME <<EOF
            version: '3.8'
            services:
              bot:
                image: $FULL_IMAGE_URL
                deploy:
                  replicas: 1
                  restart_policy:
                    condition: any
                  update_config:
                    order: stop-first
                    failure_action: rollback
                    delay: 10s
                volumes:
                  - nexus-data:/app/data
                environment:
                  - TZ=\$TZ
                  - DISCORD_TOKEN=\$DISCORD_TOKEN
                  - DISCORD_ADMIN_USER_ID=\$DISCORD_ADMIN_USER_ID
                  - LLM_API_BASE=\$LLM_API_BASE
                  - LLM_MODEL_NAME=\$LLM_MODEL_NAME
                  - API_KEY=\$API_KEY